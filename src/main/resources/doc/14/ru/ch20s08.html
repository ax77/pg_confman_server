<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>20.8. Регистрация ошибок и протоколирование работы сервера</title><meta name="generator" content="DocBook XSL Stylesheets Vsnapshot"/></head><body><div class="sect1"><div class="titlepage"><div><div><h1 class="title"><a id="runtime-config-logging"/>20.8. Регистрация ошибок и протоколирование работы сервера</h1></div></div></div><a id="id-1.6.7.11.2" class="indexterm"/><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="runtime-config-logging-where"/>20.8.1. Куда протоколировать</h2></div></div></div><a id="id-1.6.7.11.3.2" class="indexterm"/><a id="id-1.6.7.11.3.3" class="indexterm"/><div class="variablelist"><dl class="variablelist"><dt><a id="guc-log-destination"/><span class="term"><code class="varname">log_destination</code> (<code class="type">string</code>) <a id="id-1.6.7.11.3.4.1.1.3" class="indexterm"/></span></dt><dd><p><span class="productname">PostgreSQL</span> поддерживает несколько методов протоколирования сообщений сервера: <span class="systemitem">stderr</span>, <span class="systemitem">csvlog</span> и <span class="systemitem">syslog</span>. На Windows также поддерживается <span class="systemitem">eventlog</span>. В качестве значения <code class="varname">log_destination</code> указывается один или несколько методов протоколирования, разделённых запятыми. По умолчанию используется <span class="systemitem">stderr</span>. Параметр можно задать только в конфигурационных файлах или в командной строке при запуске сервера.</p><p>Если в <code class="varname">log_destination</code> включено значение <span class="systemitem">csvlog</span>, то протоколирование ведётся в формате <acronym class="acronym">CSV</acronym> (разделённые запятыми значения). Это удобно для программной обработки журнала. Подробнее об этом в <a class="xref" href="ch20s08.html#runtime-config-logging-csvlog" title="20.8.4. Использование вывода журнала в формате CSV">Подразделе 20.8.4</a>. Для вывода в формате CSV должен быть включён <a class="xref" href="ch20s08.html#guc-logging-collector">logging_collector</a>.</p><p>Если присутствует указание <span class="systemitem">stderr</span> или <span class="systemitem">csvlog</span>, создаётся файл <code class="filename">current_logfiles</code>, в который записывается расположение файла(ов) журнала, в настоящее время используемого сборщиком сообщений для соответствующего назначения. Это позволяет легко определить, какие файлы журнала используются в данный момент экземпляром сервера. Например, он может иметь такое содержание: </p><pre class="programlisting">stderr log/postgresql.log
csvlog log/postgresql.csv</pre><p> <code class="filename">current_logfiles</code> переписывается когда при прокрутке создаётся новый файл журнала или когда изменяется значение <code class="varname">log_destination</code>. Он удаляется, когда в <code class="varname">log_destination</code> не задаётся ни <span class="systemitem">stderr</span>, ни <span class="systemitem">csvlog</span>, а также когда сборщик сообщений отключён.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Примечание</h3><p>В большинстве систем Unix потребуется изменить конфигурацию системного демона <span class="application">syslog</span> для использования варианта <span class="systemitem">syslog</span> в <code class="varname">log_destination</code>. Для указания типа протоколируемой программы (facility), <span class="productname">PostgreSQL</span> может использовать значения с <code class="literal">LOCAL0</code> по <code class="literal">LOCAL7</code> (см. <a class="xref" href="ch20s08.html#guc-syslog-facility">syslog_facility</a>). Однако на большинстве платформ конфигурация <span class="application">syslog</span> по умолчанию не учитывает сообщения подобного типа. Чтобы это работало, потребуется добавить в конфигурацию демона <span class="application">syslog</span> что-то подобное: </p><pre class="programlisting">local0.*    /var/log/postgresql</pre><p>Для использования <code class="literal">eventlog</code> в <code class="varname">log_destination</code> на Windows, необходимо зарегистрировать источник событий и его библиотеку в операционной системе. Тогда Windows Event Viewer сможет отображать сообщения журнала событий. Подробнее в <a class="xref" href="ch19s12.html" title="19.12. Регистрация журнала событий в Windows">Разделе 19.12</a>.</p></div></dd><dt><a id="guc-logging-collector"/><span class="term"><code class="varname">logging_collector</code> (<code class="type">boolean</code>) <a id="id-1.6.7.11.3.4.2.1.3" class="indexterm"/></span></dt><dd><p>Параметр включает сборщик сообщений (<em class="firstterm">logging collector</em>). Это фоновый процесс, который собирает отправленные в <span class="systemitem">stderr</span> сообщения и перенаправляет их в журнальные файлы. Такой подход зачастую более полезен чем запись в <span class="application">syslog</span>, поскольку некоторые сообщения в <span class="application">syslog</span> могут не попасть. (Типичный пример с сообщениями об ошибках динамического связывания, другой пример — ошибки в скриптах типа <code class="varname">archive_command</code>.) Для установки параметра требуется перезапуск сервера.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Примечание</h3><p>Можно обойтись без сборщика сообщений и просто писать в <span class="systemitem">stderr</span>. Сообщения будут записываться в место, куда направлен поток <span class="systemitem">stderr</span>. Такой способ подойдёт только для небольших объёмов протоколирования, потому что не предоставляет удобных средств для организации ротации журнальных файлов. Кроме того, на некоторых платформах отказ от использования сборщика сообщений может привести к потере или искажению сообщений, так как несколько процессов, одновременно пишущих в один журнальный файл, могут перезаписывать информацию друг друга.</p></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Примечание</h3><p>Сборщик спроектирован так, чтобы сообщения никогда не терялись. А это значит, что при очень высокой нагрузке, серверные процессы могут быть заблокированы при попытке отправить сообщения во время сбоя фонового процесса сборщика. В противоположность этому, <span class="application">syslog</span> предпочитает удалять сообщения, при невозможности их записать. Поэтому часть сообщений может быть потеряна, но система не будет блокироваться.</p></div></dd><dt><a id="guc-log-directory"/><span class="term"><code class="varname">log_directory</code> (<code class="type">string</code>) <a id="id-1.6.7.11.3.4.3.1.3" class="indexterm"/></span></dt><dd><p>При включённом <code class="varname">logging_collector</code>, определяет каталог, в котором создаются журнальные файлы. Можно задавать как абсолютный путь, так и относительный от каталога данных кластера. Параметр можно задать только в конфигурационных файлах или в командной строке при запуске сервера. Значение по умолчанию — <code class="literal">log</code>.</p></dd><dt><a id="guc-log-filename"/><span class="term"><code class="varname">log_filename</code> (<code class="type">string</code>) <a id="id-1.6.7.11.3.4.4.1.3" class="indexterm"/></span></dt><dd><p>При включённом <code class="varname">logging_collector</code> задаёт имена журнальных файлов. Значение трактуется как строка формата в функции <code class="function">strftime</code>, поэтому в ней можно использовать спецификаторы <code class="literal">%</code> для включения в имена файлов информации о дате и времени. (При наличии зависящих от часового пояса спецификаторов <code class="literal">%</code> будет использован пояс, заданный в <a class="xref" href="ch20s08.html#guc-log-timezone">log_timezone</a>.) Поддерживаемые спецификаторы <code class="literal">%</code> похожи на те, что перечислены в описании <a class="ulink" href="https://pubs.opengroup.org/onlinepubs/009695399/functions/strftime.html">strftime</a> спецификации Open Group. Обратите внимание, что системная функция <code class="function">strftime</code> напрямую не используется. Поэтому нестандартные, специфичные для платформы особенности не будут работать. Значение по умолчанию <code class="literal">postgresql-%Y-%m-%d_%H%M%S.log</code>.</p><p>Если для задания имени файлов не используются спецификаторы <code class="literal">%</code>, то для избежания переполнения диска, следует использовать утилиты для ротации журнальных файлов. В версиях до 8.4, при отсутствии спецификаторов <code class="literal">%</code>, <span class="productname">PostgreSQL</span> автоматически добавлял время в формате Epoch к имени файла. Сейчас в этом больше нет необходимости.</p><p>Если в <code class="varname">log_destination</code> включён вывод в формате CSV, то к имени журнального файла будет добавлено расширение <code class="literal">.csv</code>. (Если <code class="varname">log_filename</code> заканчивается на <code class="literal">.log</code>, то это расширение заменится на <code class="literal">.csv</code>.)</p><p>Задать этот параметр можно только в <code class="filename">postgresql.conf</code> или в командной строке при запуске сервера.</p></dd><dt><a id="guc-log-file-mode"/><span class="term"><code class="varname">log_file_mode</code> (<code class="type">integer</code>) <a id="id-1.6.7.11.3.4.5.1.3" class="indexterm"/></span></dt><dd><p>В системах Unix задаёт права доступа к журнальным файлам, при включённом <code class="varname">logging_collector</code>. (В Windows этот параметр игнорируется.) Значение параметра должно быть числовым, в формате команд <code class="function">chmod</code> и <code class="function">umask</code>. (Для восьмеричного формата, требуется задать лидирующий <code class="literal">0</code> (ноль).)</p><p>Права доступа по умолчанию <code class="literal">0600</code>, т. е. только владелец сервера может читать и писать в журнальные файлы. Также, может быть полезным значение <code class="literal">0640</code>, разрешающее чтение файлов членам группы. Однако чтобы установить такое значение, нужно каталог для хранения журнальных файлов (<a class="xref" href="ch20s08.html#guc-log-directory">log_directory</a>) вынести за пределы каталога данных кластера. В любом случае нежелательно открывать для всех доступ на чтение журнальных файлов, так как они могут содержать конфиденциальные данные.</p><p>Задать этот параметр можно только в <code class="filename">postgresql.conf</code> или в командной строке при запуске сервера.</p></dd><dt><a id="guc-log-rotation-age"/><span class="term"><code class="varname">log_rotation_age</code> (<code class="type">integer</code>) <a id="id-1.6.7.11.3.4.6.1.3" class="indexterm"/></span></dt><dd><p>При включённом <code class="varname">logging_collector</code> этот параметр определяет максимальное время жизни отдельного журнального файла, по истечении которого создаётся новый файл. Если это значение задаётся без единиц измерения, оно считается заданным в минутах. Значение по умолчанию — 24 часа. При нулевом значении смена файлов по времени не производится. Задать этот параметр можно только в <code class="filename">postgresql.conf</code> или в командной строке при запуске сервера.</p></dd><dt><a id="guc-log-rotation-size"/><span class="term"><code class="varname">log_rotation_size</code> (<code class="type">integer</code>) <a id="id-1.6.7.11.3.4.7.1.3" class="indexterm"/></span></dt><dd><p>При включённом <code class="varname">logging_collector</code> этот параметр определяет максимальный размер отдельного журнального файла. При достижении этого размера создаётся новый файл. Если это значение задаётся без единиц измерения, оно считается заданным в килобайтах. Значение по умолчанию — 10 мегабайт. При нулевом значении смена файлов по размеру не производится. Задать этот параметр можно только в <code class="filename">postgresql.conf</code> или в командной строке при запуске сервера.</p></dd><dt><a id="guc-log-truncate-on-rotation"/><span class="term"><code class="varname">log_truncate_on_rotation</code> (<code class="type">boolean</code>) <a id="id-1.6.7.11.3.4.8.1.3" class="indexterm"/></span></dt><dd><p>Если параметр <code class="varname">logging_collector</code> включён, <span class="productname">PostgreSQL</span> будет перезаписывать существующие журнальные файлы, а не дописывать в них. Однако перезапись при переключении на новый файл возможна только в результате ротации по времени, но не при старте сервера или ротации по размеру файла. При выключенном параметре всегда продолжается запись в существующий файл. Например, включение этого параметра в комбинации с <code class="varname">log_filename</code> равным <code class="literal">postgresql-%H.log</code>, приведёт к генерации 24-х часовых журнальных файлов, которые циклически перезаписываются. Параметр можно задать только в конфигурационных файлах или в командной строке при запуске сервера.</p><p>Пример: для хранения журнальных файлов в течение 7 дней, по одному файлу на каждый день с именами вида <code class="literal">server_log.Mon</code>, <code class="literal">server_log.Tue</code> и т. д., а также с автоматической перезаписью файлов прошлой недели, нужно установить <code class="varname">log_filename</code> в <code class="literal">server_log.%a</code>, <code class="varname">log_truncate_on_rotation</code> в <code class="literal">on</code> и <code class="varname">log_rotation_age</code> в <code class="literal">1440</code>.</p><p>Пример: для хранения журнальных файлов в течение 24 часов, по одному файлу на час, с дополнительной возможностью переключения файла при превышения 1ГБ, установите <code class="varname">log_filename</code> в <code class="literal">server_log.%H%M</code>, <code class="varname">log_truncate_on_rotation</code> в <code class="literal">on</code>, <code class="varname">log_rotation_age</code> в <code class="literal">60</code> и <code class="varname">log_rotation_size</code> в <code class="literal">1000000</code>. Добавление <code class="literal">%M</code> в <code class="varname">log_filename</code> позволит при переключении по размеру указать другое имя файла в пределах одного часа.</p></dd><dt><a id="guc-syslog-facility"/><span class="term"><code class="varname">syslog_facility</code> (<code class="type">enum</code>) <a id="id-1.6.7.11.3.4.9.1.3" class="indexterm"/></span></dt><dd><p>При включённом протоколировании в <span class="application">syslog</span>, этот параметр определяет значение <span class="quote">«<span class="quote">facility</span>»</span>. Допустимые значения <code class="literal">LOCAL0</code>, <code class="literal">LOCAL1</code>, <code class="literal">LOCAL2</code>, <code class="literal">LOCAL3</code>, <code class="literal">LOCAL4</code>, <code class="literal">LOCAL5</code>, <code class="literal">LOCAL6</code>, <code class="literal">LOCAL7</code>. По умолчанию используется <code class="literal">LOCAL0</code>. Подробнее в документации на системный демон <span class="application">syslog</span>. Параметр можно задать только в конфигурационных файлах или в командной строке при запуске сервера.</p></dd><dt><a id="guc-syslog-ident"/><span class="term"><code class="varname">syslog_ident</code> (<code class="type">string</code>) <a id="id-1.6.7.11.3.4.10.1.3" class="indexterm"/></span></dt><dd><p>При включённом протоколировании в <span class="application">syslog</span>, этот параметр задаёт имя программы, которое будет использоваться в <span class="application">syslog</span> для идентификации сообщений относящихся к <span class="productname">PostgreSQL</span>. По умолчанию используется <code class="literal">postgres</code>. Задать этот параметр можно только в <code class="filename">postgresql.conf</code> или в командной строке при запуске сервера.</p></dd><dt><a id="guc-syslog-sequence-numbers"/><span class="term"><code class="varname">syslog_sequence_numbers</code> (<code class="type">boolean</code>) <a id="id-1.6.7.11.3.4.11.1.3" class="indexterm"/></span></dt><dd><p>Когда сообщения выводятся в <span class="application">syslog</span> и этот параметр включён (по умолчанию), все сообщения будут предваряться последовательно увеличивающимися номерами (например, <code class="literal">[2]</code>). Это позволяет обойти подавление повторов <span class="quote">«<span class="quote">--- последнее сообщение повторилось N раз ---</span>»</span>, которое по умолчанию осуществляется во многих реализациях syslog. В более современных реализациях syslog подавление повторных сообщений можно настроить (например, в <span class="productname">rsyslog</span> есть директива <code class="literal">$RepeatedMsgReduction</code>), так что это может излишне. Если же вы действительно хотите, чтобы повторные сообщения подавлялись, вы можете отключить этот параметр.</p><p>Задать этот параметр можно только в <code class="filename">postgresql.conf</code> или в командной строке при запуске сервера.</p></dd><dt><a id="guc-syslog-split-messages"/><span class="term"><code class="varname">syslog_split_messages</code> (<code class="type">boolean</code>) <a id="id-1.6.7.11.3.4.12.1.3" class="indexterm"/></span></dt><dd><p>Когда активен вывод сообщений в <span class="application">syslog</span>, этот параметр определяет, как будут доставляться сообщения. Если он включён (по умолчанию), сообщения разделяются по строкам, а длинные строки разбиваются на строки не длиннее 1024 байт, что составляет типичное ограничение размера для традиционных реализаций syslog. Когда он отключён, сообщения сервера PostgreSQL передаются службе syslog как есть, и она должна сама корректно воспринять потенциально длинные сообщения.</p><p>Если syslog в итоге выводит сообщения в текстовый файл, результат будет тем же и лучше оставить этот параметр включённым, так как многие реализации syslog не способны обрабатывать большие сообщения или их нужно специально настраивать для этого. Но если syslog направляет сообщения в некоторую другую среду, может потребоваться или будет удобнее сохранять логическую целостность сообщений.</p><p>Задать этот параметр можно только в <code class="filename">postgresql.conf</code> или в командной строке при запуске сервера.</p></dd><dt><a id="guc-event-source"/><span class="term"><code class="varname">event_source</code> (<code class="type">string</code>) <a id="id-1.6.7.11.3.4.13.1.3" class="indexterm"/></span></dt><dd><p>При включённом протоколировании в <span class="application">event log</span>, этот параметр задаёт имя программы, которое будет использоваться в журнале событий для идентификации сообщений относящихся к <span class="productname">PostgreSQL</span>. По умолчанию используется <code class="literal">PostgreSQL</code>. Параметр можно задать только в конфигурационных файлах или в командной строке при запуске сервера.</p></dd></dl></div></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="runtime-config-logging-when"/>20.8.2. Когда протоколировать</h2></div></div></div><div class="variablelist"><dl class="variablelist"><dt><a id="guc-log-min-messages"/><span class="term"><code class="varname">log_min_messages</code> (<code class="type">enum</code>) <a id="id-1.6.7.11.4.2.1.1.3" class="indexterm"/></span></dt><dd><p>Управляет минимальным <a class="link" href="ch20s08.html#runtime-config-severity-levels" title="Таблица 20.2. Уровни важности сообщений">уровнем сообщений</a>, записываемых в журнал сервера. Допустимые значения <code class="literal">DEBUG5</code>, <code class="literal">DEBUG4</code>, <code class="literal">DEBUG3</code>, <code class="literal">DEBUG2</code>, <code class="literal">DEBUG1</code>, <code class="literal">INFO</code>, <code class="literal">NOTICE</code>, <code class="literal">WARNING</code>, <code class="literal">ERROR</code>, <code class="literal">LOG</code>, <code class="literal">FATAL</code> и <code class="literal">PANIC</code>. Каждый из перечисленных уровней включает все идущие после него. Чем дальше в этом списке уровень сообщения, тем меньше сообщений будет записано в журнал сервера. По умолчанию используется <code class="literal">WARNING</code>. Обратите внимание, позиция <code class="literal">LOG</code> здесь отличается от принятой в <a class="xref" href="ch20s11.html#guc-client-min-messages">client_min_messages</a>. Только суперпользователи могут изменить этот параметр.</p></dd><dt><a id="guc-log-min-error-statement"/><span class="term"><code class="varname">log_min_error_statement</code> (<code class="type">enum</code>) <a id="id-1.6.7.11.4.2.2.1.3" class="indexterm"/></span></dt><dd><p>Управляет тем, какие SQL-операторы, завершившиеся ошибкой, записываются в журнал сервера. SQL-оператор будет записан в журнал, если он завершится ошибкой с указанным <a class="link" href="ch20s08.html#runtime-config-severity-levels" title="Таблица 20.2. Уровни важности сообщений">уровнем важности</a> или выше. Допустимые значения: <code class="literal">DEBUG5</code>, <code class="literal">DEBUG4</code>, <code class="literal">DEBUG3</code>, <code class="literal">DEBUG2</code>, <code class="literal">DEBUG1</code>, <code class="literal">INFO</code>, <code class="literal">NOTICE</code>, <code class="literal">WARNING</code>, <code class="literal">ERROR</code>, <code class="literal">LOG</code>, <code class="literal">FATAL</code> и <code class="literal">PANIC</code>. По умолчанию используется <code class="literal">ERROR</code>. Это означает, что в журнал сервера будут записаны все операторы, завершившиеся сообщением с уровнем важности <code class="literal">ERROR</code>, <code class="literal">LOG</code>, <code class="literal">FATAL</code> и <code class="literal">PANIC</code>. Чтобы фактически отключить запись операторов с ошибками, установите для этого параметра значение <code class="literal">PANIC</code>. Изменить этот параметр могут только суперпользователи.</p></dd><dt><a id="guc-log-min-duration-statement"/><span class="term"><code class="varname">log_min_duration_statement</code> (<code class="type">integer</code>) <a id="id-1.6.7.11.4.2.3.1.3" class="indexterm"/></span></dt><dd><p>Записывает в журнал продолжительность выполнения всех команд, время работы которых не меньше указанного. Например, при значении <code class="literal">250ms</code> в журнал сервера будут записаны все команды, выполняющиеся 250 миллисекунд и дольше. С помощью этого параметра можно выявить неоптимизированные запросы в приложениях. Если значение этого параметра задаётся без единиц измерения, оно считается заданным в миллисекундах. При нулевом значении записывается продолжительность выполнения всех команд. Со значением -1 (по умолчанию) запись полностью отключается. Изменить этот параметр могут только суперпользователи.</p><p>Этот параметр переопределяет <a class="xref" href="ch20s08.html#guc-log-min-duration-sample">log_min_duration_sample</a>, то есть запросы с длительностью, превышающей заданное значение, всегда фиксируются в журнале, вне зависимости от параметров извлечения выборки.</p><p>Для клиентов, использующих расширенный протокол запросов, будет записываться продолжительность фаз: разбор, связывание и выполнение.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Примечание</h3><p>При использовании совместно с <a class="xref" href="ch20s08.html#guc-log-statement">log_statement</a>, текст SQL-операторов будет записываться только один раз (от использования <code class="varname">log_statement</code>) и не будет задублирован в сообщении о длительности выполнения. Если не используется вывод в <span class="application">syslog</span>, то рекомендуется в <a class="xref" href="ch20s08.html#guc-log-line-prefix">log_line_prefix</a> включить идентификатор процесса или сессии. Это позволит связать текст запроса с записью о продолжительности выполнения, которая появится позже.</p></div></dd><dt><a id="guc-log-min-duration-sample"/><span class="term"><code class="varname">log_min_duration_sample</code> (<code class="type">integer</code>) <a id="id-1.6.7.11.4.2.4.1.3" class="indexterm"/></span></dt><dd><p>Позволяет сделать выборку по продолжительности команд, которые выполнялись не менее чем определённое время. При этом в журнал будут вноситься такие же записи, как и при включённом параметре <a class="xref" href="ch20s08.html#guc-log-min-duration-statement">log_min_duration_statement</a>, но не для всех команд, а только для их подмножества, ограничиваемого параметром <a class="xref" href="ch20s08.html#guc-log-statement-sample-rate">log_statement_sample_rate</a>. Например, при значении <code class="literal">100ms</code> предварительно для выборки будут отобраны все SQL-операторы, выполняющиеся 100 миллисекунд и дольше. Этот параметр может быть полезен, когда количество запросов слишком велико, чтобы записывать в журнал их все. Если значение этого параметра задаётся без единиц измерения, оно считается заданным в миллисекундах. При нулевом значении для выборки отбираются команды с любой продолжительностью. Со значением -1 (по умолчанию) формирование выборки по продолжительности полностью отключается. Изменить этот параметр могут только суперпользователи.</p><p>Этот параметр имеет меньший приоритет, чем <code class="varname">log_min_duration_statement</code>, то есть команды с длительностью, превышающей <code class="varname">log_min_duration_statement</code>, будут регистрироваться в журнале всегда, вне зависимости от того, какой будет выборка.</p><p>Другие замечания, относящиеся к <code class="varname">log_min_duration_statement</code>, применимы так же и к данному параметру.</p></dd><dt><a id="guc-log-statement-sample-rate"/><span class="term"><code class="varname">log_statement_sample_rate</code> (<code class="type">floating point</code>) <a id="id-1.6.7.11.4.2.5.1.3" class="indexterm"/></span></dt><dd><p>Определяет, какая доля команд с длительностью, достигшей <a class="xref" href="ch20s08.html#guc-log-min-duration-sample">log_min_duration_sample</a>, будет регистрироваться в журнале. Выборка формируется вероятностным образом, например, со значением <code class="literal">0.5</code> можно считать, что шанс попадания каждой отдельной команды в выборку равен один к двум. Значение по умолчанию — <code class="literal">1.0</code>, то есть выбираются и регистрируются все команды. Со значением 0 запись команд выборки, в зависимости от их длительности, отключается, так же как и при <code class="varname">log_min_duration_sample</code>, равном <code class="literal">-1</code>. Изменить этот параметр могут только суперпользователи.</p></dd><dt><a id="guc-log-transaction-sample-rate"/><span class="term"><code class="varname">log_transaction_sample_rate</code> (<code class="type">floating point</code>) <a id="id-1.6.7.11.4.2.6.1.3" class="indexterm"/></span></dt><dd><p>Задаёт долю транзакций, команды из которых будут записываться в журнал дополнительно (помимо команд, записываемых по другим причинам). Этот параметр действует на все транзакции, независимо от длительности команд. Выборка осуществляется вероятностным образом, например, со значением <code class="literal">0.1</code> можно считать, что каждая транзакция может попасть в журнал с шансом один к десяти. Параметр <code class="varname">log_transaction_sample_rate</code> может быть полезен для анализа выборки транзакций. Значение по умолчанию — <code class="literal">0</code>, то есть команды из дополнительно выбираемых транзакций не записываются. При значении <code class="literal">1</code> записываются все команды из всех транзакций. Изменить этот параметр могут только суперпользователи.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Примечание</h3><p>С этим параметром, как и со всеми остальными, управляющими журналированием команд, могут быть связаны значительные издержки.</p></div></dd></dl></div><p>В <a class="xref" href="ch20s08.html#runtime-config-severity-levels" title="Таблица 20.2. Уровни важности сообщений">Таблице 20.2</a> поясняются уровни важности сообщений в <span class="productname">PostgreSQL</span>. Также в этой таблице показано, как эти уровни транслируются в системные при использовании <span class="systemitem">syslog</span> или <span class="systemitem">eventlog</span> в Windows.</p><div class="table"><a id="runtime-config-severity-levels"/><p class="title"><strong>Таблица 20.2. Уровни важности сообщений</strong></p><div class="table-contents"><table class="table" summary="Уровни важности сообщений" border="1"><colgroup><col class="col1"/><col class="col2"/><col class="col3"/><col class="col4"/></colgroup><thead><tr><th>Уровень</th><th>Использование</th><th><span class="systemitem">syslog</span></th><th><span class="systemitem">eventlog</span></th></tr></thead><tbody><tr><td><code class="literal">DEBUG1 .. DEBUG5</code></td><td>Более детальная информация для разработчиков. Чем больше номер, тем детальнее.</td><td><code class="literal">DEBUG</code></td><td><code class="literal">INFORMATION</code></td></tr><tr><td><code class="literal">INFO</code></td><td>Неявно запрошенная пользователем информация, например вывод команды <span class="command"><strong>VACUUM VERBOSE</strong></span>.</td><td><code class="literal">INFO</code></td><td><code class="literal">INFORMATION</code></td></tr><tr><td><code class="literal">NOTICE</code></td><td>Информация, которая может быть полезной пользователям. Например, уведомления об усечении длинных идентификаторов.</td><td><code class="literal">NOTICE</code></td><td><code class="literal">INFORMATION</code></td></tr><tr><td><code class="literal">WARNING</code></td><td>Предупреждения о возможных проблемах. Например, <span class="command"><strong>COMMIT</strong></span> вне транзакционного блока.</td><td><code class="literal">NOTICE</code></td><td><code class="literal">WARNING</code></td></tr><tr><td><code class="literal">ERROR</code></td><td>Сообщает об ошибке, из-за которой прервана текущая команда.</td><td><code class="literal">WARNING</code></td><td><code class="literal">ERROR</code></td></tr><tr><td><code class="literal">LOG</code></td><td>Информация, полезная для администраторов. Например, выполнение контрольных точек.</td><td><code class="literal">INFO</code></td><td><code class="literal">INFORMATION</code></td></tr><tr><td><code class="literal">FATAL</code></td><td>Сообщает об ошибке, из-за которой прервана текущая сессия.</td><td><code class="literal">ERR</code></td><td><code class="literal">ERROR</code></td></tr><tr><td><code class="literal">PANIC</code></td><td>Сообщает об ошибке, из-за которой прерваны все сессии.</td><td><code class="literal">CRIT</code></td><td><code class="literal">ERROR</code></td></tr></tbody></table></div></div></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="runtime-config-logging-what"/>20.8.3. Что протоколировать</h2></div></div></div><div class="variablelist"><dl class="variablelist"><dt><a id="guc-application-name"/><span class="term"><code class="varname">application_name</code> (<code class="type">string</code>) <a id="id-1.6.7.11.5.2.1.1.3" class="indexterm"/></span></dt><dd><p><code class="varname">application_name</code> это любая строка, не превышающая <code class="symbol">NAMEDATALEN</code> символов (64 символа при стандартной сборке). Обычно устанавливается приложением при подключении к серверу. Значение отображается в представлении <code class="structname">pg_stat_activity</code> и добавляется в журнал сервера, при использовании формата CSV. Для прочих форматов, <code class="varname">application_name</code> можно добавить в журнал через параметр <a class="xref" href="ch20s08.html#guc-log-line-prefix">log_line_prefix</a>. Значение <code class="varname">application_name</code> может содержать только печатные ASCII символы. Остальные символы будут заменены знаками вопроса (<code class="literal">?</code>).</p></dd><dt><span class="term"><code class="varname">debug_print_parse</code> (<code class="type">boolean</code>) <a id="id-1.6.7.11.5.2.2.1.3" class="indexterm"/><br/></span><span class="term"><code class="varname">debug_print_rewritten</code> (<code class="type">boolean</code>) <a id="id-1.6.7.11.5.2.2.2.3" class="indexterm"/><br/></span><span class="term"><code class="varname">debug_print_plan</code> (<code class="type">boolean</code>) <a id="id-1.6.7.11.5.2.2.3.3" class="indexterm"/></span></dt><dd><p>Эти параметры включают вывод различной отладочной информации. А именно: вывод дерева запроса, дерево запроса после применения правил или плана выполнения запроса, соответственно. Все эти сообщения имеют уровень <code class="literal">LOG</code>. Поэтому, по умолчанию, они записываются в журнал сервера, но не отправляются клиенту. Отправку клиенту можно настроить через <a class="xref" href="ch20s11.html#guc-client-min-messages">client_min_messages</a> и/или <a class="xref" href="ch20s08.html#guc-log-min-messages">log_min_messages</a>. По умолчанию параметры выключены.</p></dd><dt><span class="term"><code class="varname">debug_pretty_print</code> (<code class="type">boolean</code>) <a id="id-1.6.7.11.5.2.3.1.3" class="indexterm"/></span></dt><dd><p>Включает выравнивание сообщений, выводимых <code class="varname">debug_print_parse</code>, <code class="varname">debug_print_rewritten</code> или <code class="varname">debug_print_plan</code>. В результате сообщения легче читать, но они значительно длиннее, чем в формате <span class="quote">«<span class="quote">compact</span>»</span>, который используется при выключенном значении. По умолчанию включён.</p></dd><dt><a id="guc-log-autovacuum-min-duration"/><span class="term"><code class="varname">log_autovacuum_min_duration</code> (<code class="type">integer</code>) <a id="id-1.6.7.11.5.2.4.1.3" class="indexterm"/></span></dt><dd><p>Задаёт время выполнения действия автоочистки, при превышении которого информация об этом действии записывается в журнал. При нулевом значении в журнале фиксируются все действия автоочистки. Значение <code class="literal">-1</code> (по умолчанию) отключает журналирование действий автоочистки. Если это значение задаётся без единиц измерения, оно считается заданным в миллисекундах. Например, если задать значение <code class="literal">250ms</code>, в журнале будут фиксироваться все операции автоматической очистки и анализа, выполняемые дольше 250 мс. Кроме того, когда этот параметр имеет любое значение, отличное от <code class="literal">-1</code>, в журнал будет записываться сообщение в случае пропуска действия автоочистки из-за конфликтующей блокировки или параллельного удаления отношения. Таким образом, включение этого параметра позволяет отслеживать активность автоочистки. Задать этот параметр можно только в <code class="filename">postgresql.conf</code> или в командной строке при запуске сервера. Однако его можно переопределить для отдельных таблиц, изменив их параметры хранения.</p></dd><dt><a id="guc-log-checkpoints"/><span class="term"><code class="varname">log_checkpoints</code> (<code class="type">boolean</code>) <a id="id-1.6.7.11.5.2.5.1.3" class="indexterm"/></span></dt><dd><p>Включает протоколирование выполнения контрольных точек и точек перезапуска сервера. При этом записывается некоторая статистическая информация. Например, число записанных буферов и время, затраченное на их запись. Параметр можно задать только в конфигурационных файлах или в командной строке при запуске сервера. По умолчанию выключен.</p></dd><dt><a id="guc-log-connections"/><span class="term"><code class="varname">log_connections</code> (<code class="type">boolean</code>) <a id="id-1.6.7.11.5.2.6.1.3" class="indexterm"/></span></dt><dd><p>Включает протоколирование всех попыток подключения к серверу, в том числе успешного завершения как аутентификации (если она требуется), так и авторизации клиентов. Изменить его можно только в начале сеанса и сделать это могут только суперпользователи. Значение по умолчанию — <code class="literal">off</code>.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Примечание</h3><p>Некоторые программы, например <span class="application">psql</span>, предпринимают две попытки подключения (первая для определения, нужен ли пароль). Поэтому дублирование сообщения <span class="quote">«<span class="quote">connection received</span>»</span> не обязательно говорит о наличии проблемы.</p></div></dd><dt><a id="guc-log-disconnections"/><span class="term"><code class="varname">log_disconnections</code> (<code class="type">boolean</code>) <a id="id-1.6.7.11.5.2.7.1.3" class="indexterm"/></span></dt><dd><p>Включает протоколирование завершения сеанса. В журнал выводится примерно та же информация, что и с <code class="varname">log_connections</code>, плюс длительность сеанса. Изменить этот параметр можно только в начале сеанса и сделать это могут только суперпользователи. Значение по умолчанию — <code class="literal">off</code>.</p></dd><dt><a id="guc-log-duration"/><span class="term"><code class="varname">log_duration</code> (<code class="type">boolean</code>) <a id="id-1.6.7.11.5.2.8.1.3" class="indexterm"/></span></dt><dd><p>Записывает продолжительность каждой завершённой команды. По умолчанию выключен. Только суперпользователи могут изменить этот параметр.</p><p>Для клиентов, использующих расширенный протокол запросов, будет записываться продолжительность фаз: разбор, связывание и выполнение.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Примечание</h3><p>Включение параметра <code class="varname">log_duration</code> не равнозначно установке нулевого значения для <a class="xref" href="ch20s08.html#guc-log-min-duration-statement">log_min_duration_statement</a>. Разница в том, что при превышении значения <code class="varname">log_min_duration_statement</code> в журнал записывается текст запроса, а при включении данного параметра — нет. Таким образом, при <code class="varname">log_duration</code> = <code class="literal">on</code> и положительном значении <code class="varname">log_min_duration_statement</code> в журнал записывается длительность для всех команд, а текст запроса — только для команд с длительностью, превышающей предел. Такое поведение может оказаться полезным при сборе статистики в условиях большой нагрузки.</p></div></dd><dt><a id="guc-log-error-verbosity"/><span class="term"><code class="varname">log_error_verbosity</code> (<code class="type">enum</code>) <a id="id-1.6.7.11.5.2.9.1.3" class="indexterm"/></span></dt><dd><p>Управляет количеством детальной информации, записываемой в журнал сервера для каждого сообщения. Допустимые значения: <code class="literal">TERSE</code>, <code class="literal">DEFAULT</code> и <code class="literal">VERBOSE</code>. Каждое последующее значение добавляет больше полей в выводимое сообщение. Для <code class="literal">TERSE</code> из сообщения об ошибке исключаются поля <code class="literal">DETAIL</code>, <code class="literal">HINT</code>, <code class="literal">QUERY</code> и <code class="literal">CONTEXT</code>. Для <code class="literal">VERBOSE</code> в сообщение включается код ошибки <code class="symbol">SQLSTATE</code> (см. <a class="xref" href="apa.html" title="Приложение A. Коды ошибок PostgreSQL">Приложение A</a>), а также имя файла с исходным кодом, имя функции и номер строки сгенерировавшей ошибку. Только суперпользователи могут изменить этот параметр.</p></dd><dt><a id="guc-log-hostname"/><span class="term"><code class="varname">log_hostname</code> (<code class="type">boolean</code>) <a id="id-1.6.7.11.5.2.10.1.3" class="indexterm"/></span></dt><dd><p>По умолчанию, сообщения журнала содержат лишь IP-адрес подключившегося клиента. При включении этого параметра, дополнительно будет фиксироваться и имя сервера. Обратите внимание, что в зависимости от применяемого способа разрешения имён, это может отрицательно сказаться на производительности. Задать этот параметр можно только в <code class="filename">postgresql.conf</code> или в командной строке при запуске сервера.</p></dd><dt><a id="guc-log-line-prefix"/><span class="term"><code class="varname">log_line_prefix</code> (<code class="type">string</code>) <a id="id-1.6.7.11.5.2.11.1.3" class="indexterm"/></span></dt><dd><p>Строка, в стиле функции <code class="function">printf</code>, которая выводится в начале каждой строки журнала сообщений. С символов <code class="literal">%</code> начинаются управляющие последовательности, которые заменяются статусной информацией, описанной ниже. Неизвестные управляющие последовательности игнорируются. Все остальные символы напрямую копируются в выводимую строку. Некоторые управляющие последовательности используются только для пользовательских процессов и будут игнорироваться фоновыми процессами, например основным процессом сервера. Статусная информация может быть выровнена по ширине влево или вправо указанием числа после % и перед кодом последовательности. Отрицательное число дополняет значение пробелами справа до заданной ширины, а положительное число — слева. Выравнивание может быть полезно для улучшения читаемости.</p><p>Этот параметр можно задать только в <code class="filename">postgresql.conf</code> или в командной строке при запуске сервера. По умолчанию этот параметр имеет значение <code class="literal">'%m [%p] '</code>, с которым в журнал выводится время и идентификатор процесса (PID).</p><div class="informaltable"><table class="informaltable" border="1"><colgroup><col/><col/><col/></colgroup><thead><tr><th>Спецсимвол</th><th>Назначение</th><th>Только для пользовательского процесса</th></tr></thead><tbody><tr><td><code class="literal">%a</code></td><td>Имя приложения (<a class="xref" href="ch20s08.html#guc-application-name">application_name</a>)</td><td>да</td></tr><tr><td><code class="literal">%u</code></td><td>Имя пользователя</td><td>да</td></tr><tr><td><code class="literal">%d</code></td><td>Имя базы данных</td><td>да</td></tr><tr><td><code class="literal">%r</code></td><td>Имя удалённого узла или IP-адрес, а также номер порта</td><td>да</td></tr><tr><td><code class="literal">%h</code></td><td>Имя удалённого узла или IP-адрес</td><td>да</td></tr><tr><td><code class="literal">%b</code></td><td>Тип обслуживающего процесса</td><td>нет</td></tr><tr><td><code class="literal">%p</code></td><td>Идентификатор процесса</td><td>нет</td></tr><tr><td><code class="literal">%P</code></td><td>Идентификатор ведущего процесса группы, если текущий процесс является исполнителем параллельного запроса</td><td>нет</td></tr><tr><td><code class="literal">%t</code></td><td>Штамп времени, без миллисекунд</td><td>нет</td></tr><tr><td><code class="literal">%m</code></td><td>Штамп времени, с миллисекундами</td><td>нет</td></tr><tr><td><code class="literal">%n</code></td><td>Штамп времени, с миллисекундами (в виде времени Unix)</td><td>нет</td></tr><tr><td><code class="literal">%i</code></td><td>Тег команды: тип текущей команды в сессии</td><td>да</td></tr><tr><td><code class="literal">%e</code></td><td>Код ошибки SQLSTATE</td><td>нет</td></tr><tr><td><code class="literal">%c</code></td><td>Идентификатор сессии. Подробности ниже</td><td>нет</td></tr><tr><td><code class="literal">%l</code></td><td>Номер строки журнала для каждой сессии или процесса. Начинается с 1</td><td>нет</td></tr><tr><td><code class="literal">%s</code></td><td>Штамп времени начала процесса</td><td>нет</td></tr><tr><td><code class="literal">%v</code></td><td>Идентификатор виртуальной транзакции (backendID/localXID)</td><td>нет</td></tr><tr><td><code class="literal">%x</code></td><td>Идентификатор транзакции (0 если не присвоен)</td><td>нет</td></tr><tr><td><code class="literal">%q</code></td><td>Ничего не выводит. Непользовательские процессы останавливаются в этой точке. Игнорируется пользовательскими процессами</td><td>нет</td></tr><tr><td><code class="literal">%Q</code></td><td>Идентификатор текущего запроса. Вычисление идентификаторов запроса по умолчанию отключено, поэтому в этом поле будет выводиться значение 0, если не включён параметр <a class="xref" href="ch20s09.html#guc-compute-query-id">compute_query_id</a> или не настроен дополнительный модуль, вычисляющий идентификаторы запросов.</td><td>да</td></tr><tr><td><code class="literal">%%</code></td><td>Выводит <code class="literal">%</code></td><td>нет</td></tr></tbody></table></div><p>Тип обслуживающего процесса соответствует содержимому столбца <code class="structfield">backend_type</code> в представлении <a class="link" href="ch28s02.html#monitoring-pg-stat-activity-view" title="28.2.3. pg_stat_activity"><code class="structname">pg_stat_activity</code></a>, но в журнале могут фигурировать и другие типы, которые не показываются в этом представлении.</p><p>Спецпоследовательность <code class="literal">%c</code> заменяется на практически уникальный идентификатор сеанса, содержащий из 4 шестнадцатеричных чисел (без ведущих нулей), разделённых точками. Эти числа представляют время запуска процесса и его PID, так что <code class="literal">%c</code> можно использовать как более компактную альтернативу совокупности этих двух элементов. Чтобы получить такой идентификатор сеанса, например из <code class="literal">pg_stat_activity</code>, воспользуйтесь этим запросом: </p><pre class="programlisting">SELECT to_hex(trunc(EXTRACT(EPOCH FROM backend_start))::integer) || '.' ||
       to_hex(pid)
FROM pg_stat_activity;</pre><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Подсказка</h3><p>Последним символом в <code class="varname">log_line_prefix</code> лучше оставлять пробел, чтобы отделить от остальной строки. Можно использовать и символы пунктуации.</p></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Подсказка</h3><p><span class="application">Syslog</span> также формирует штамп времени и идентификатор процесса, поэтому вероятно нет смысла использовать соответствующие управляющие последовательности при использовании <span class="application">syslog</span>.</p></div><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Подсказка</h3><p>Спецпоследовательность <code class="literal">%q</code> полезна для включения информации, которая существует только в контексте сеанса (обслуживающего процесса), например, имя пользователя или базы данных. Например: </p><pre class="programlisting">log_line_prefix = '%m [%p] %q%u@%d/%a '</pre></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Примечание</h3><p>Спецпоследовательность <code class="literal">%Q</code> всегда выдаёт нулевой идентификатор для строк, выводимых посредством <a class="xref" href="ch20s08.html#guc-log-statement">log_statement</a>, потому что соответствующий вывод <code class="varname">log_statement</code> формируется до вычисления этого идентификатора, в том числе и для некорректных операторов, для которых идентификатор вычислить нельзя.</p></div></dd><dt><a id="guc-log-lock-waits"/><span class="term"><code class="varname">log_lock_waits</code> (<code class="type">boolean</code>) <a id="id-1.6.7.11.5.2.12.1.3" class="indexterm"/></span></dt><dd><p>Определяет, нужно ли фиксировать в журнале события, когда сеанс ожидает получения блокировки дольше, чем указано в <a class="xref" href="ch20s12.html#guc-deadlock-timeout">deadlock_timeout</a>. Это позволяет выяснить, не связана ли низкая производительность с ожиданием блокировок. По умолчанию отключено. Только суперпользователи могут изменить этот параметр.</p></dd><dt><a id="guc-log-recovery-conflict-waits"/><span class="term"><code class="varname">log_recovery_conflict_waits</code> (<code class="type">boolean</code>) <a id="id-1.6.7.11.5.2.13.1.3" class="indexterm"/></span></dt><dd><p>Определяет, нужно ли фиксировать в журнале события, когда сеанс ожидает получения блокировки дольше, чем указано в <code class="varname">deadlock_timeout</code> для конфликтов восстановления. Это позволяет выяснить, препятствуют ли конфликты восстановления применению WAL.</p><p>Значение по умолчанию — <code class="literal">off</code> (выкл.). Задать этот параметр можно только в <code class="filename">postgresql.conf</code> или в командной строке при запуске сервера.</p></dd><dt><a id="guc-log-parameter-max-length"/><span class="term"><code class="varname">log_parameter_max_length</code> (<code class="type">integer</code>) <a id="id-1.6.7.11.5.2.14.1.3" class="indexterm"/></span></dt><dd><p>Положительное значение устанавливает количество байт, до которого будут усекаться значения привязанных SQL-параметров, выводимые в сообщениях вместе с SQL-операторами (это не относится к регистрации ошибок). Ноль отключает вывод значений привязанных параметров в таких сообщениях. Значение <code class="literal">-1</code> (по умолчанию) позволяет получить в журнале привязанные параметры в полном объёме. Если значение этого параметра задаётся без единиц измерения, оно считается заданным в байтах. Изменить этот параметр могут только суперпользователи.</p><p>Этот параметр влияет только на сообщения, выводимые в журнал по критериям, которые устанавливают параметры <a class="xref" href="ch20s08.html#guc-log-statement">log_statement</a>, <a class="xref" href="ch20s08.html#guc-log-duration">log_duration</a> и связанные с ними. С ненулевыми значениями этого параметра сопряжены некоторые издержки, особенно если привязанные значения передаются в двоичной форме, так как их нужно будет переводить в текстовый вид.</p></dd><dt><a id="guc-log-parameter-max-length-on-error"/><span class="term"><code class="varname">log_parameter_max_length_on_error</code> (<code class="type">integer</code>) <a id="id-1.6.7.11.5.2.15.1.3" class="indexterm"/></span></dt><dd><p>Положительное значение устанавливает количество байт, до которого будут усекаться значения привязанных SQL-параметров, выводимые вместе с SQL-операторами при регистрации ошибок. Нулевое значение отключает вывод значений привязанных операторов в сообщениях об ошибках. Значение <code class="literal">-1</code> (по умолчанию) позволяет получить в журнале привязанные параметры в полном объёме. Если значение этого параметра задаётся без единиц измерения, оно считается заданным в байтах.</p><p>С ненулевыми значениями этого параметра сопряжены некоторые издержки, так как <span class="productname">PostgreSQL</span> должен будет сформировать в памяти текстовые представления всех значений параметров перед выполнением всех операторов, в том числе, выполненных в итоге без ошибок. Издержки дополнительно возрастают, когда привязанные параметры передаются не в текстовой, а в двоичной форме, так как их недостаточно просто скопировать в строку, их нужно ещё преобразовать.</p></dd><dt><a id="guc-log-statement"/><span class="term"><code class="varname">log_statement</code> (<code class="type">enum</code>) <a id="id-1.6.7.11.5.2.16.1.3" class="indexterm"/></span></dt><dd><p>Управляет тем, какие SQL-команды записывать в журнал. Допустимые значения: <code class="literal">none</code> (отключено), <code class="literal">ddl</code>, <code class="literal">mod</code> и <code class="literal">all</code> (все команды). <code class="literal">ddl</code> записывает все команды определения данных, такие как <span class="command"><strong>CREATE</strong></span>, <span class="command"><strong>ALTER</strong></span>, <span class="command"><strong>DROP</strong></span>. <code class="literal">mod</code> записывает все команды <code class="literal">ddl</code>, а также команды изменяющие данные, такие как <span class="command"><strong>INSERT</strong></span>, <span class="command"><strong>UPDATE</strong></span>, <span class="command"><strong>DELETE</strong></span>, <span class="command"><strong>TRUNCATE</strong></span> и <span class="command"><strong>COPY FROM</strong></span>. <span class="command"><strong>PREPARE</strong></span>, <span class="command"><strong>EXECUTE</strong></span> и <span class="command"><strong>EXPLAIN ANALYZE</strong></span> также записываются, если вызваны для команды соответствующего типа. Если клиент использует расширенный протокол запросов, то запись происходит на фазе выполнения и содержит значения всех связанных переменных (если есть символы одиночных кавычек, то они дублируются).</p><p>По умолчанию <code class="literal">none</code>. Только суперпользователи могут изменить этот параметр.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><h3 class="title">Примечание</h3><p>Команды с синтаксическими ошибками не записываются, даже если <code class="varname">log_statement</code> = <code class="literal">all</code>, так как сообщение формируется только после выполнения предварительного разбора, определяющего тип команды. При расширенном протоколе запросов, похожим образом не будут записываться команды, неуспешно завершившиеся до фазы выполнения (например, при разборе или построении плана запроса). Для включения в журнал таких команд установите <code class="varname">log_min_error_statement</code> в <code class="literal">ERROR</code> (или ниже).</p></div></dd><dt><a id="guc-log-replication-commands"/><span class="term"><code class="varname">log_replication_commands</code> (<code class="type">boolean</code>) <a id="id-1.6.7.11.5.2.17.1.3" class="indexterm"/></span></dt><dd><p>Включает запись в журнал сервера всех команд репликации. Подробнее о командах репликации можно узнать в <a class="xref" href="ch53s04.html" title="53.4. Протокол потоковой репликации">Разделе 53.4</a>. Значение по умолчанию — <code class="literal">off</code>. Изменить этот параметр могут только суперпользователи.</p></dd><dt><a id="guc-log-temp-files"/><span class="term"><code class="varname">log_temp_files</code> (<code class="type">integer</code>) <a id="id-1.6.7.11.5.2.18.1.3" class="indexterm"/></span></dt><dd><p>Управляет регистрацией в журнале имён и размеров временных файлов. Временные файлы могут использоваться для сортировки, хеширования и временного хранения результатов запросов. Когда этот параметр включён, при удалении временного файла информация о нём может записываться в журнал. При нулевом значении записывается информация обо всех файлах, а при положительном — о файлах, размер которых не меньше заданной величины. Если это значение задаётся без единиц измерения, оно считается заданным в килобайтах. Значение по умолчанию равно -1, то есть запись такой информации отключена. Изменить этот параметр могут только суперпользователи.</p></dd><dt><a id="guc-log-timezone"/><span class="term"><code class="varname">log_timezone</code> (<code class="type">string</code>) <a id="id-1.6.7.11.5.2.19.1.3" class="indexterm"/></span></dt><dd><p>Устанавливает часовой пояс для штампов времени при записи в журнал сервера. В отличие от <a class="xref" href="ch20s11.html#guc-timezone">TimeZone</a>, это значение одинаково для всех баз данных кластера, поэтому для всех сессий используются согласованные значения штампов времени. Встроенное значение по умолчанию <code class="literal">GMT</code>, но оно переопределяется в <code class="filename">postgresql.conf</code>: <span class="application">initdb</span> записывает в него значение, соответствующее системной среде. Подробнее об этом в <a class="xref" href="ch08s05.html#datatype-timezones" title="8.5.3. Часовые пояса">Подразделе 8.5.3</a>. Задать этот параметр можно только в <code class="filename">postgresql.conf</code> или в командной строке при запуске сервера.</p></dd></dl></div></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="runtime-config-logging-csvlog"/>20.8.4. Использование вывода журнала в формате CSV</h2></div></div></div><p>Добавление <code class="literal">csvlog</code> в <code class="varname">log_destination</code> делает удобным загрузку журнальных файлов в таблицу базы данных. Строки журнала представляют собой значения, разделённые запятыми (формат <acronym class="acronym">CSV</acronym>), со следующими полями: штамп времени с миллисекундами; имя пользователя; имя базы данных; идентификатор процесса; клиентский узел:номер порта; идентификатор сессии; номер строки каждой сессии; тег команды; время начала сессии; виртуальный идентификатор транзакции; идентификатор транзакции; уровень важности ошибки; код ошибки SQLSTATE; сообщение об ошибке; подробности к сообщению об ошибке; подсказка к сообщению об ошибке; внутренний запрос, приведший к ошибке (если есть); номер символа внутреннего запроса, где произошла ошибка; контекст ошибки; запрос пользователя, приведший к ошибке (если есть и включён <code class="varname">log_min_error_statement</code>); номер символа в запросе пользователя, где произошла ошибка; расположение ошибки в исходном коде PostgreSQL (если <code class="varname">log_error_verbosity</code> установлен в <code class="literal">verbose</code>), имя приложения, тип обслуживающего процесса, идентификатор ведущего процесса группы и идентификатор запроса. Вот пример определения таблицы, для хранения журналов в формате CSV: </p><pre class="programlisting">CREATE TABLE postgres_log
(
  log_time timestamp(3) with time zone,
  user_name text,
  database_name text,
  process_id integer,
  connection_from text,
  session_id text,
  session_line_num bigint,
  command_tag text,
  session_start_time timestamp with time zone,
  virtual_transaction_id text,
  transaction_id bigint,
  error_severity text,
  sql_state_code text,
  message text,
  detail text,
  hint text,
  internal_query text,
  internal_query_pos integer,
  context text,
  query text,
  query_pos integer,
  location text,
  application_name text,
  backend_type text,
  leader_pid integer,
  query_id bigint,
  PRIMARY KEY (session_id, session_line_num)
);</pre><p>Для загрузки журнального файла в такую таблицу можно использовать команду <span class="command"><strong>COPY FROM</strong></span>: </p><pre class="programlisting">COPY postgres_log FROM '/full/path/to/logfile.csv' WITH csv;</pre><p> Также можно обратиться к этому файлу как к сторонней таблице, используя поставляемый модуль <a class="xref" href="apfs14.html" title="F.14. file_fdw">file_fdw</a>.</p><p>Для упрощения загрузки журналов в CSV формате используйте следующее: </p><div class="orderedlist"><ol class="orderedlist"><li class="listitem"><p>Установите для <code class="varname">log_filename</code> и <code class="varname">log_rotation_age</code> значения, гарантирующие согласованную и предсказуемую схему именования журнальных файлов. Зная, какие имена будут у журнальных файлов, можно определить, когда конкретный файл заполнен и готов к загрузке.</p></li><li class="listitem"><p>Установите <code class="varname">log_rotation_size</code> в 0, чтобы запретить ротацию файлов по достижении определённого размера, так как это делает непредсказуемой схему именования журнальных файлов.</p></li><li class="listitem"><p>Установите <code class="varname">log_truncate_on_rotation</code> в <code class="literal">on</code>, чтобы новые сообщения не смешивались со старыми при переключении на существующий файл.</p></li><li class="listitem"><p>Определение таблицы содержит первичный ключ. Это полезно для предотвращения случайной повторной загрузки данных. Команда <span class="command"><strong>COPY</strong></span> фиксирует изменения один раз, поэтому любая ошибка приведёт к отмене всей загрузки. Если сначала загрузить неполный журнальный файл, то его повторная загрузка (по заполнении) приведёт к нарушению первичного ключа и, следовательно, к ошибке загрузки. Поэтому необходимо дожидаться окончания записи в журнальный файл перед началом загрузки. Похожим образом предотвращается случайная загрузка частично сформированной строки сообщения, что также приведёт к сбою в команде <span class="command"><strong>COPY</strong></span>.</p></li></ol></div></div><div class="sect2"><div class="titlepage"><div><div><h2 class="title"><a id="id-1.6.7.11.7"/>20.8.5. Заголовок процесса</h2></div></div></div><p>Эти параметры влияют на то, как формируются заголовки серверных процессов. Заголовок процесса обычно можно наблюдать в программах типа <span class="application">ps</span>, а в Windows — в <span class="application">Process Explorer</span>. За подробностями обратитесь к <a class="xref" href="ch28.html#monitoring-ps" title="28.1. Стандартные инструменты Unix">Разделу 28.1</a>.</p><div class="variablelist"><dl class="variablelist"><dt><a id="guc-cluster-name"/><span class="term"><code class="varname">cluster_name</code> (<code class="type">string</code>) <a id="id-1.6.7.11.7.3.1.1.3" class="indexterm"/></span></dt><dd><p>Задаёт имя, которое идентифицирует данный кластер (экземпляр сервера) для различных целей. Имя кластера выводится в заголовке процесса для всех серверных процессов в данном кластере. Более того, это имя будет именем приложения по умолчанию, используемым при подключении ведомого сервера (см. <a class="xref" href="ch20s06.html#guc-synchronous-standby-names">synchronous_standby_names</a>.)</p><p>Это имя может быть любой строкой не длиннее <code class="symbol">NAMEDATALEN</code> символов (64 символа в стандартной сборке). В строке <code class="varname">cluster_name</code> могут использоваться только печатаемые ASCII-символы. Любой другой символ будет заменён символом вопроса (<code class="literal">?</code>). Если этот параметр содержит пустую строку <code class="literal">''</code> (это значение по умолчанию), никакое имя не выводится. Этот параметр можно задать только при запуске сервера.</p></dd><dt><a id="guc-update-process-title"/><span class="term"><code class="varname">update_process_title</code> (<code class="type">boolean</code>) <a id="id-1.6.7.11.7.3.2.1.3" class="indexterm"/></span></dt><dd><p>Включает изменение заголовка процесса при получении сервером каждой очередной команды SQL. На большинстве платформ он включён (имеет значение <code class="literal">on</code>), но в Windows по умолчанию выключен (<code class="literal">off</code>) ввиду больших издержек на изменение этого заголовка. Изменить этот параметр могут только суперпользователи.</p></dd></dl></div></div></div></body></html>